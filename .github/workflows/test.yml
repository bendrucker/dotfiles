name: tests
on:
  push:
    branches: [main]
  pull_request:
jobs:
  bootstrap:
    strategy:
      matrix:
        os:
          - ubuntu-22.04
          - macos-14
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true
    - name: Link to home
      run: ln -s "$PWD" "$HOME/.dotfiles"
    - name: Add brew bin/ to Linux $PATH
      if: ${{ runner.os == 'Linux' }}
      run: |
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        echo "${HOMEBREW_PREFIX}/bin" >> "$GITHUB_PATH"
    - name: Install zsh on Linux
      if: ${{ runner.os == 'Linux' }}
      run: sudo apt-get install -y zsh
    - name: Overwrite conflicting formulae
      if: ${{ runner.os == 'macOS' }}
      run: |
        brew update
        brew upgrade openssl@3 || brew link --overwrite openssl@3
    - name: Print Homebrew configuration
      run: brew config
    - name: Cache mise installs
      uses: actions/cache@v5
      with:
        key: mise-${{ runner.os }}-${{ hashFiles('**/mise/config.toml') }}
        restore-keys: |
          mise-${{ runner.os }}-
        path: |
          ~/.local/share/mise
    - name: Cache Homebrew packages
      uses: actions/cache@v5
      with:
        key: homebrew-${{ runner.os }}-${{ hashFiles('**/Brewfile') }}
        restore-keys: |
          homebrew-${{ runner.os }}-
        path: |
          ~/Library/Caches/Homebrew
          /home/linuxbrew/.linuxbrew
    - name: Bootstrap
      run: ./scripts/bootstrap
      env:
        # skip updates/upgrades to speed up install
        HOMEBREW_NO_INSTALL_UPGRADE: '1'
        # remove stale packages from cache
        HOMEBREW_BUNDLE_INSTALL_CLEANUP: '1'
        # skip deps installed without homebrew in https://github.com/actions/virtual-environments/blob/main/images/macos/macos-10.15-Readme.md
        HOMEBREW_BUNDLE_BREW_SKIP: >
          awscli
          go
          golangci-lint
          kubernetes-cli
          kubectx
          minikube
          python
          python@3.11
          python@3.12
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  lint-brewfiles:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ast-grep/action@cf62e780f0c88301228978d593a7784427a097a6 # v1.5.0
        with:
          paths: '*/Brewfile'
  startup-time:
    runs-on: macos-14
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
      - name: Link to home
        run: ln -s "$PWD" "$HOME/.dotfiles"
      - name: Overwrite conflicting formulae
        run: |
          brew update
          brew upgrade openssl@3 || brew link --overwrite openssl@3
      - name: Cache Homebrew packages
        uses: actions/cache@v5
        with:
          key: homebrew-startup-${{ hashFiles('**/Brewfile') }}
          restore-keys: |
            homebrew-startup-
          path: |
            ~/Library/Caches/Homebrew
      - name: Bootstrap
        run: ./scripts/bootstrap
        env:
          HOMEBREW_NO_INSTALL_UPGRADE: '1'
          HOMEBREW_BUNDLE_INSTALL_CLEANUP: '1'
          HOMEBREW_BUNDLE_BREW_SKIP: >
            awscli
            go
            golangci-lint
            kubernetes-cli
            kubectx
            minikube
            python
            python@3.11
            python@3.12
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Install hyperfine
        run: brew install hyperfine
      - name: Benchmark shell startup
        run: |
          hyperfine --warmup 3 --runs 10 --shell=none \
            'zsh -i -c exit' \
            --export-json /tmp/bench.json
          median=$(python3 -c "import json; print(json.load(open('/tmp/bench.json'))['results'][0]['median'])")
          echo "Median startup: ${median}s"
          python3 -c "
          import json, sys
          median = json.load(open('/tmp/bench.json'))['results'][0]['median']
          if median > 1.0:
              print(f'FAIL: median startup {median:.3f}s > 1.0s')
              sys.exit(1)
          print(f'OK: median startup {median:.3f}s')
          "
  lint-completion-names:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Check completion file naming convention
        run: |
          bad=$(find . -name 'completions.zsh' -not -path './.git/*')
          if [[ -n "$bad" ]]; then
            echo "ERROR: Files named 'completions.zsh' bypass the zshrc completion filter."
            echo "Rename to 'completion.zsh' (singular):"
            echo "$bad"
            exit 1
          fi
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # tag=2.0.0
        env:
          SHELLCHECK_OPTS: -e SC1071
