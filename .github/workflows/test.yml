name: tests
on:
  push:
    branches: [main]
  pull_request:
jobs:
  bootstrap:
    strategy:
      matrix:
        include:
          - name: linux
            os: ubuntu-22.04
          - name: macos
            os: macos-15
    name: bootstrap (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: true
    - name: Link to home
      run: ln -s "$PWD" "$HOME/.dotfiles"
    - name: Add brew bin/ to Linux $PATH
      if: ${{ runner.os == 'Linux' }}
      run: |
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        echo "${HOMEBREW_PREFIX}/bin" >> "$GITHUB_PATH"
    - name: Install zsh on Linux
      if: ${{ runner.os == 'Linux' }}
      run: sudo apt-get install -y zsh
    - name: Overwrite conflicting formulae
      if: ${{ runner.os == 'macOS' }}
      run: |
        brew update
        brew upgrade openssl@3 || brew link --overwrite openssl@3
    - name: Print Homebrew configuration
      run: brew config
    - name: Cache mise installs
      uses: actions/cache@v5
      with:
        key: mise-${{ runner.os }}-${{ hashFiles('**/mise/config.toml') }}
        restore-keys: |
          mise-${{ runner.os }}-
        path: |
          ~/.local/share/mise
    - name: Cache Homebrew packages
      uses: actions/cache@v5
      with:
        key: homebrew-${{ runner.os }}-${{ hashFiles('**/Brewfile') }}
        restore-keys: |
          homebrew-${{ runner.os }}-
        path: |
          ~/Library/Caches/Homebrew
          /home/linuxbrew/.linuxbrew
    - name: Bootstrap
      run: ./scripts/bootstrap
      env:
        # skip updates/upgrades to speed up install
        HOMEBREW_NO_INSTALL_UPGRADE: '1'
        # remove stale packages from cache
        HOMEBREW_BUNDLE_INSTALL_CLEANUP: '1'
        # skip deps installed without homebrew in https://github.com/actions/virtual-environments/blob/main/images/macos/macos-10.15-Readme.md
        HOMEBREW_BUNDLE_BREW_SKIP: >
          awscli
          go
          golangci-lint
          kubernetes-cli
          kubectx
          minikube
          python
          python@3.11
          python@3.12
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Test tmux
      run: |
        tmux_stderr=$(mktemp)
        trap 'tmux kill-server 2>/dev/null; rm -f "$tmux_stderr"' EXIT

        tmux_exit=0
        tmux new-session -d -s test 2>"$tmux_stderr" || tmux_exit=$?
        if [[ $tmux_exit -ne 0 ]]; then
          echo "FAIL: tmux new-session exited with code $tmux_exit"
          cat "$tmux_stderr"
          exit 1
        fi
        if [[ -s "$tmux_stderr" ]]; then
          echo "FAIL: tmux new-session wrote to stderr:"
          cat "$tmux_stderr"
          exit 1
        fi

        # tmux = catppuccin/tmux (TPM uses repo name as directory)
        for plugin in tpm tmux-resurrect tmux-continuum tmux tmux-fzf-links; do
          if [[ ! -d "$HOME/.tmux/plugins/$plugin" ]]; then
            echo "FAIL: plugin directory missing: ~/.tmux/plugins/$plugin"
            exit 1
          fi
          echo "OK: ~/.tmux/plugins/$plugin"
        done

        tmux_opt() {
          local val
          if ! val=$(tmux show-options -gv "$1" 2>&1); then
            echo "FAIL: tmux show-options $1 failed: $val"
            exit 1
          fi
          echo "$val"
        }

        thm_surface_2=$(tmux_opt @thm_surface_2)
        if [[ -z "$thm_surface_2" ]]; then
          echo "FAIL: @thm_surface_2 not set (catppuccin theme not loaded)"
          exit 1
        fi
        echo "OK: @thm_surface_2=$thm_surface_2"

        prefix=$(tmux_opt prefix)
        if [[ "$prefix" != "C-s" ]]; then
          echo "FAIL: prefix=$prefix, expected C-s"
          exit 1
        fi
        echo "OK: prefix=$prefix"

        status_position=$(tmux_opt status-position)
        if [[ "$status_position" != "top" ]]; then
          echo "FAIL: status-position=$status_position, expected top"
          exit 1
        fi
        echo "OK: status-position=$status_position"
    - name: Benchmark shell startup
      run: |
        hyperfine --warmup 3 --runs 10 --shell=none \
          'zsh -i -c exit' \
          --export-json /tmp/bench.json \
          --export-markdown /tmp/bench.md

        median=$(python3 -c "import json; print(json.load(open('/tmp/bench.json'))['results'][0]['median'])")

        {
          echo '## Shell Startup Benchmark'
          echo ''
          echo '```'
          hyperfine --warmup 0 --runs 1 --shell=none 'zsh -i -c exit'
          echo '```'
          echo ''
          cat /tmp/bench.md
          echo ''
          echo '<details><summary>ZPROF breakdown</summary>'
          echo ''
          echo '```'
          ZPROF=1 zsh -i -c exit 2>&1
          echo '```'
          echo ''
          echo '</details>'
        } >> "$GITHUB_STEP_SUMMARY"

        python3 -c "
        import json, sys
        median = json.load(open('/tmp/bench.json'))['results'][0]['median']
        if median > 1.0:
            print(f'FAIL: median startup {median:.3f}s > 1.0s')
            sys.exit(1)
        print(f'OK: median startup {median:.3f}s')
        "
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: j178/prek-action@v1
      - name: Check completion file naming convention
        run: |
          bad=$(find . -name 'completions.zsh' -not -path './.git/*')
          if [[ -n "$bad" ]]; then
            echo "ERROR: Files named 'completions.zsh' bypass the zshrc completion filter."
            echo "Rename to 'completion.zsh' (singular):"
            echo "$bad"
            exit 1
          fi
