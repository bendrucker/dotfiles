#!/usr/bin/env zsh
#
# Run all dotfiles installers.

set -e

cd "$(dirname "$0")"/..

# Detect non-interactive mode (explicit setting or non-tty stdin)
if [[ -z "${NONINTERACTIVE-}" ]] && [[ ! -t 0 ]]; then
  export NONINTERACTIVE=1
fi

echo "â€º brew bundle"
brew bundle

# Expose brew configuration to installers
eval "$(brew shellenv)"

# Install mise tools and activate shims
source mise/install.sh

# Build exclusions for mise and any git submodules
local -a excludes=("!" "-path" "./mise/*")
for sm_path in ${(f)"$(git submodule foreach --quiet 'echo $sm_path' 2>/dev/null)"}; do
  excludes+=("!" "-path" "./$sm_path/*")
done

# Find and run topic installers
find . -name install.sh "${excludes[@]}" | while read -r installer; do "${installer}"; done
