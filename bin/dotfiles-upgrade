#!/usr/bin/env zsh
# shellcheck shell=bash
# Nightly dotfiles sync and dependency upgrade
# Syncs dotfiles, runs scripts/install, creates Things task on failure

set -e

DOTFILES_HOME="${DOTFILES_HOME:-$HOME/.dotfiles}"
LOG_TAG="dotfiles-upgrade"

log() {
  local msg="$1"
  logger -t "$LOG_TAG" "$msg" 2>/dev/null || true
  echo "$msg"
}

notify() {
  local title="$1"
  local message="$2"

  if [[ "$(uname)" != "Darwin" ]]; then
    return
  fi

  osascript -e "display notification \"$message\" with title \"$title\" sound name \"Basso\"" 2>/dev/null || true
}

sync_dotfiles() {
  log "Syncing dotfiles..."

  if [[ -L "$DOTFILES_HOME" ]]; then
    log "ERROR: $DOTFILES_HOME is a symlink - run scripts/setup first"
    notify "Dotfiles Upgrade" "Failed: ~/.dotfiles is a symlink"
    return 1
  fi

  if [[ ! -d "$DOTFILES_HOME/.git" ]]; then
    log "ERROR: $DOTFILES_HOME is not a git repository"
    notify "Dotfiles Upgrade" "Failed: not a git repository"
    return 1
  fi

  cd "$DOTFILES_HOME"

  if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
    log "ERROR: Local changes in $DOTFILES_HOME - skipping sync"
    notify "Dotfiles Upgrade" "Skipped: local changes present"
    return 1
  fi

  local default_branch
  default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
  if [[ -z "$default_branch" ]]; then
    git remote set-head origin --auto 2>/dev/null || true
    default_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
  fi
  default_branch="${default_branch:-main}"

  local retries=4 delay=2
  for ((i=1; i<=retries; i++)); do
    if git fetch origin "$default_branch" 2>&1; then
      break
    fi
    if ((i < retries)); then
      log "Fetch failed, retrying in ${delay}s... (attempt $i/$retries)"
      sleep "$delay"
      delay=$((delay * 2))
    else
      log "ERROR: Failed to fetch after retries"
      notify "Dotfiles Upgrade" "Failed: network error"
      return 1
    fi
  done

  local local_rev remote_rev
  local_rev=$(git rev-parse HEAD)
  remote_rev=$(git rev-parse "origin/$default_branch")

  if [[ "$local_rev" == "$remote_rev" ]]; then
    log "Dotfiles already up to date (${local_rev:0:7})"
    return 0
  fi

  log "Updating dotfiles from ${local_rev:0:7} to ${remote_rev:0:7}..."

  if git pull --ff-only origin "$default_branch" 2>&1; then
    log "Dotfiles updated to $(git rev-parse --short HEAD)"
  else
    log "ERROR: Failed to pull dotfiles"
    notify "Dotfiles Upgrade" "Failed: could not pull"
    return 1
  fi
}

run_install() {
  log "Running install..."
  local output
  if ! output=$("$DOTFILES_HOME/scripts/install" 2>&1); then
    log "ERROR: install failed"
    echo "$output"
    create_things_task "$output"
    return 1
  fi
  echo "$output"
}

run_brew_cleanup() {
  log "Running brew cleanup..."
  brew cleanup 2>&1 || log "WARNING: brew cleanup had issues"
}

create_things_task() {
  local output="$1"

  log "Creating Things task for install failure..."

  local notes='```sh
brew bundle
```

## Error Output
```
'"$output"'
```'

  local encoded_notes encoded_title
  encoded_notes=$(echo "$notes" | jq -sRr @uri)
  encoded_title=$(echo "Dotfiles install failed" | jq -sRr @uri)

  open "things:///add?title=${encoded_title}&notes=${encoded_notes}&when=today"

  notify "Dotfiles Upgrade" "Install failed - see Things task"
}

# --- Main ---
if ! sync_dotfiles; then
  exit 1
fi

if ! run_install; then
  exit 1
fi

run_brew_cleanup

log "All upgrades completed successfully"
