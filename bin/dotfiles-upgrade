#!/usr/bin/env zsh
# shellcheck shell=bash
# Nightly dotfiles sync and dependency upgrade
# Syncs dotfiles, runs scripts/install, creates Things task on failure

set -e

DOTFILES_HOME="${DOTFILES_HOME:-$HOME/.dotfiles}"
LOG_TAG="dotfiles-upgrade"

log() {
  local msg="$1"
  logger -t "$LOG_TAG" "$msg" 2>/dev/null || true
  echo "$msg"
}

notify() {
  local title="$1"
  local message="$2"

  if [[ "$(uname)" != "Darwin" ]]; then
    return
  fi

  osascript -e "display notification \"$message\" with title \"$title\" sound name \"Basso\"" 2>/dev/null || true
}

sync_dotfiles() {
  log "Syncing dotfiles..."
  "$DOTFILES_HOME/bin/dotfiles-sync"
}

run_install() {
  log "Running install..."
  local output
  if ! output=$("$DOTFILES_HOME/scripts/install" 2>&1); then
    log "ERROR: install failed"
    echo "$output"
    create_things_task "$output"
    return 1
  fi
  echo "$output"
}

run_brew_cleanup() {
  log "Running brew cleanup..."
  brew cleanup 2>&1 || log "WARNING: brew cleanup had issues"
}

create_things_task() {
  local output="$1"

  log "Creating Things task for install failure..."

  local notes='```sh
brew bundle
```

## Error Output
```
'"$output"'
```'

  local encoded_notes encoded_title
  encoded_notes=$(echo "$notes" | jq -sRr @uri)
  encoded_title=$(echo "Dotfiles install failed" | jq -sRr @uri)

  open "things:///add?title=${encoded_title}&notes=${encoded_notes}&when=today"

  notify "Dotfiles Upgrade" "Install failed - see Things task"
}

# --- Main ---
if ! sync_dotfiles; then
  exit 1
fi

if ! run_install; then
  exit 1
fi

run_brew_cleanup

log "All upgrades completed successfully"
